name: Unit Tests

on:
  pull_request:

permissions:
  pull-requests: write

jobs:
  run-tests:
    strategy:
      # Run all tests to provide feedback on full branch
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"

      - name: Get current date and time
        id: get-date
        run: echo "CURRENT_DATE=$(date)" >> $GITHUB_ENV

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.5.24"

      - name: Sync dependencies
        run: uv sync --locked

      - name: Run tests
        id: run-tests
        run: |
          uv run coverage run -m pytest --tb=short | tee >(grep -A 5 "FAILED" > failed_tests.txt)
          exit ${PIPESTATUS[0]}
        #  uv run coverage run -m pytest --tb=short | tee /dev/tty | grep -A 5 "FAILED" > failed_tests.txt
        #  run: uv run coverage run -m pytest

      - name: Read failed tests
        # if: ${{ steps.run-tests.outcome == 'failure' }}
        # if: ${{ steps.run-test.status != '0' }}
        if: ${{ steps.run-tests.conclusion != 'success' }}
        id: read-failed-tests
        run: |
          if [ -f failed_tests.txt ]; then
            FAILED_TESTS=$(cat failed_tests.txt)
            echo "FAILED_TESTS<<EOF" >> $GITHUB_ENV
            echo "$FAILED_TESTS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      # - name: Comment on PR if tests fail
      #   id: comment-pr
      #   if: failure()
      #   uses: thollander/actions-comment-pull-request@v3
      #   with:
      #     comment-tag: to-update
      #     mode: upsert
      #     # create-if-not-exists: true
      #     # reactions: eyes, rocket
      #     message: |
      #       "ðŸš¨ Some tests failed! Please review the logs before approving or taking the risk. Date: ${{ env.CURRENT_DATE }}"
      #       "Failed Tests:"
      #       ""
      #       "${{ env.FAILED_TESTS }}"

      - name: Comment on PR
        id: comment-pr
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: to-update
          mode: upsert
          message: |
            ${{ steps.run-tests.conclusion != 'success' }} && 'ðŸš¨ Some tests failed! Please review the logs before approving or taking the risk. Date: ${{ env.CURRENT_DATE }}\nFailed Tests:\n${{ env.FAILED_TESTS }}' }} || 'ðŸŽ‰ All tests passed! Great job! Date: ${{ env.CURRENT_DATE }}'

      - name: Create a PR status badge
        id: pr-status-badge
        uses: actions/github-script@v7
        with:
          script: |
            if: (${{ steps.run-tests.conclusion != 'success' }}) {
              message = "âŒ Some tests failed. See logs for details. âŒ\n ${{ env.FAILED_TESTS }}";
              core.summary.addHeading("âŒ Some tests failed âŒ")
                          .addRaw(message)
                          .write();
            } else {
              message = "âœ… All tests passed. Great job! âœ…";
              core.summary.addHeading("âœ… All tests passed âœ…")
                          .addRaw(message)
                          .write();
            }

      # - name: Save test results
      #   if: failure()
      #   run: echo "âŒ Some tests failed. See logs for details." >> $GITHUB_STEP_SUMMARY

